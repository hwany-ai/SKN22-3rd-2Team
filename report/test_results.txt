============================= test session starts =============================
platform win32 -- Python 3.13.9, pytest-9.0.2, pluggy-1.5.0 -- C:\Users\Playdata\miniconda3\python.exe
cachedir: .pytest_cache
metadata: {'Python': '3.13.9', 'Platform': 'Windows-11-10.0.26100-SP0', 'Packages': {'pytest': '9.0.2', 'pluggy': '1.5.0'}, 'Plugins': {'anyio': '4.12.0', 'langsmith': '0.6.4', 'asyncio': '1.3.0', 'html': '4.2.0', 'metadata': '3.1.1'}, 'JAVA_HOME': 'C:\\Program Files\\Android\\Android Studio\\jbr'}
rootdir: C:\Workspaces\SKN22-3rd-2Team
plugins: anyio-4.12.0, langsmith-0.6.4, asyncio-1.3.0, html-4.2.0, metadata-3.1.1
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 27 items

tests/test_hybrid_search.py::TestHybridSearchRRF::test_cross_rank_verification_top_tier FAILED [  3%]
tests/test_hybrid_search.py::TestHybridSearchRRF::test_symmetric_weighting PASSED [  7%]
tests/test_hybrid_search.py::TestHybridSearchRRF::test_asymmetric_weighting_dense_heavy FAILED [ 11%]
tests/test_hybrid_search.py::TestHybridSearchRRF::test_asymmetric_weighting_sparse_heavy PASSED [ 14%]
tests/test_hybrid_search.py::TestHybridSearchRRF::test_edge_case_empty_dense_results PASSED [ 18%]
tests/test_hybrid_search.py::TestHybridSearchRRF::test_edge_case_empty_sparse_results PASSED [ 22%]
tests/test_hybrid_search.py::TestHybridSearchRRF::test_edge_case_both_empty PASSED [ 25%]
tests/test_hybrid_search.py::TestHybridSearchRRF::test_rrf_k_constant_effect PASSED [ 29%]
tests/test_parser.py::TestClaimParserLevel1Regex::test_standard_us_format_basic PASSED [ 33%]
tests/test_parser.py::TestClaimParserLevel1Regex::test_claim_numbering PASSED [ 37%]
tests/test_parser.py::TestClaimParserLevel1Regex::test_independent_vs_dependent_detection PASSED [ 40%]
tests/test_parser.py::TestClaimParserLevel1Regex::test_rag_component_detection FAILED [ 44%]
tests/test_parser.py::TestClaimParserLevel1Regex::test_claim_text_content PASSED [ 48%]
tests/test_parser.py::TestClaimParserLevel2Structure::test_bracket_numbered_format FAILED [ 51%]
tests/test_parser.py::TestClaimParserLevel2Structure::test_korean_format_parsing PASSED [ 55%]
tests/test_parser.py::TestClaimParserLevel2Structure::test_mixed_indent_structure PASSED [ 59%]
tests/test_parser.py::TestClaimParserLevel3NLP::test_ocr_noise_handling PASSED [ 62%]
tests/test_parser.py::TestClaimParserLevel3NLP::test_nlp_disabled_graceful_fallback PASSED [ 66%]
tests/test_parser.py::TestClaimParserLevel3NLP::test_sentence_boundary_mock PASSED [ 70%]
tests/test_parser.py::TestClaimParserLevel4Minimal::test_raw_text_blob_fallback PASSED [ 74%]
tests/test_parser.py::TestClaimParserLevel4Minimal::test_empty_input_handling PASSED [ 77%]
tests/test_parser.py::TestClaimParserLevel4Minimal::test_whitespace_only_input PASSED [ 81%]
tests/test_parser.py::TestClaimParserLevel4Minimal::test_single_paragraph_fallback PASSED [ 85%]
tests/test_parser.py::TestClaimParserLevel4Minimal::test_multiple_paragraphs_fallback FAILED [ 88%]
tests/test_parser.py::TestClaimParserDataIntegrity::test_parsed_claim_dataclass_fields PASSED [ 92%]
tests/test_parser.py::TestClaimParserDataIntegrity::test_char_and_word_counts PASSED [ 96%]
tests/test_parser.py::TestClaimParserDataIntegrity::test_claims_sorted_by_number PASSED [100%]

================================== FAILURES ===================================
__________ TestHybridSearchRRF.test_cross_rank_verification_top_tier __________

self = <test_hybrid_search.TestHybridSearchRRF object at 0x000001B3EC544910>
dense_search_results = [<MagicMock id='1872276773184'>, <MagicMock id='1872276773856'>, <MagicMock id='1872276774192'>, <MagicMock id='1872276774528'>, <MagicMock id='1872276774864'>, <MagicMock id='1872276775200'>, ...]
sparse_search_results = [('doc_b', 15.0, {'content': 'Document B - Top in Sparse', 'patent_id': 'US-002'}), ('doc_l', 12.0, {'content': 'Docum...content': 'Document O', 'patent_id': 'US-015'}), ('doc_p', 5.0, {'content': 'Document P', 'patent_id': 'US-016'}), ...]

    def test_cross_rank_verification_top_tier(
        self,
        dense_search_results,
        sparse_search_results
    ):
        """
        Cross-Rank Verification (The 'Top-tier' Test):
    
        Setup:
        - Doc A: Ranked #1 in Dense Search, unranked in Sparse Search
        - Doc B: Ranked #1 in Sparse Search, unranked in Dense Search
        - Doc C: Ranked #10 in both searches
    
        Expectation:
        After RRF fusion, both Doc A and Doc B must appear in the Top 3 results
        due to their high individual rankings.
        """
        # Execute RRF fusion
        results = rrf_fusion(
            dense_results=dense_search_results,
            sparse_results=sparse_search_results,
            dense_weight=0.5,
            sparse_weight=0.5,
            rrf_k=60,
        )
    
        # Get top 3 chunk IDs
        top_3_ids = [chunk_id for chunk_id, _ in results[:3]]
    
        # Assertions
        assert "doc_a" in top_3_ids, (
            f"Doc A (Dense #1) should be in Top 3, but Top 3 is: {top_3_ids}"
        )
        assert "doc_b" in top_3_ids, (
            f"Doc B (Sparse #1) should be in Top 3, but Top 3 is: {top_3_ids}"
        )
    
        # Doc C should NOT be in top 3 (ranked #10 in both)
>       assert "doc_c" not in top_3_ids, (
            f"Doc C (ranked #10 in both) should NOT be in Top 3, but it is: {top_3_ids}"
        )
E       AssertionError: Doc C (ranked #10 in both) should NOT be in Top 3, but it is: ['doc_c', 'doc_a', 'doc_b']
E       assert 'doc_c' not in ['doc_c', 'doc_a', 'doc_b']

tests\test_hybrid_search.py:172: AssertionError
__________ TestHybridSearchRRF.test_asymmetric_weighting_dense_heavy __________

self = <test_hybrid_search.TestHybridSearchRRF object at 0x000001B3EC4E9480>
dense_search_results = [<MagicMock id='1872276782592'>, <MagicMock id='1872277602384'>, <MagicMock id='1872277602720'>, <MagicMock id='1872277603056'>, <MagicMock id='1872277603392'>, <MagicMock id='1872277603728'>, ...]
sparse_search_results = [('doc_b', 15.0, {'content': 'Document B - Top in Sparse', 'patent_id': 'US-002'}), ('doc_l', 12.0, {'content': 'Docum...content': 'Document O', 'patent_id': 'US-015'}), ('doc_p', 5.0, {'content': 'Document P', 'patent_id': 'US-016'}), ...]

    def test_asymmetric_weighting_dense_heavy(
        self,
        dense_search_results,
        sparse_search_results
    ):
        """
        Weighting Logic - Asymmetric (0.8:0.2):
    
        With dense_weight=0.8, documents ranked high in Dense search
        should have higher RRF scores than those ranked high only in Sparse.
        """
        results = rrf_fusion(
            dense_results=dense_search_results,
            sparse_results=sparse_search_results,
            dense_weight=0.8,
            sparse_weight=0.2,
            rrf_k=60,
        )
    
        scores = {chunk_id: score for chunk_id, score in results}
    
        # Doc A (Dense #1) should score higher than Doc B (Sparse #1)
        assert scores["doc_a"] > scores["doc_b"], (
            f"With dense_weight=0.8, Doc A (Dense #1: {scores['doc_a']:.6f}) should score higher "
            f"than Doc B (Sparse #1: {scores['doc_b']:.6f})"
        )
    
        # Verify doc_a is #1 overall
        top_id = results[0][0]
>       assert top_id == "doc_a", (
            f"With dense_weight=0.8, Doc A should be #1, but #{1} is: {top_id}"
        )
E       AssertionError: With dense_weight=0.8, Doc A should be #1, but #1 is: doc_c
E       assert 'doc_c' == 'doc_a'
E         
E         - doc_a
E         ?     ^
E         + doc_c
E         ?     ^

tests\test_hybrid_search.py:237: AssertionError
___________ TestClaimParserLevel1Regex.test_rag_component_detection ___________

self = <test_parser.TestClaimParserLevel1Regex object at 0x000001B3EC4EA780>
parser = <preprocessor.ClaimParser object at 0x000001B3EC4EBA80>
standard_us_claims = '\n1. A method for neural network-based document retrieval comprising:\n   receiving a query from a user;\n   generati...r; and\n   a memory containing instructions that when executed cause the processor to perform the method of claim 1.\n'

    def test_rag_component_detection(self, parser, standard_us_claims):
        """
        Level 1 (Regex): Detect RAG component keywords in claims.
        """
        claims = parser.parse_claims_text(standard_us_claims)
    
        # Claim 1 should detect "retrieval", "embedding", "vector"
        claim_1 = next(c for c in claims if c.claim_number == 1)
    
>       assert "retrieval" in claim_1.rag_components, (
            f"Should detect 'retrieval' in claim 1, got: {claim_1.rag_components}"
        )
E       AssertionError: Should detect 'retrieval' in claim 1, got: []
E       assert 'retrieval' in []
E        +  where [] = ParsedClaim(claim_number=1, claim_text='A method for neural network-based document retrieval comprising: receiving a query from a user; generating an embedding vector from the query; searching a vector database for similar documents; returning ranked results to the user.', claim_type='independent', parent_claim=None, rag_components=[], char_count=231, word_count=34).rag_components

tests\test_parser.py:177: AssertionError
_________ TestClaimParserLevel2Structure.test_bracket_numbered_format _________

self = <test_parser.TestClaimParserLevel2Structure object at 0x000001B3EC546350>
parser = <preprocessor.ClaimParser object at 0x000001B396148170>
bracket_numbered_claims = '\n(1) A method for patent analysis comprising:\n    extracting claims from a patent document;\n    parsing the claims...laim 1, wherein the parsing uses NLP techniques.\n\n[3] A computer-readable medium storing instructions for claim 1.\n'

    def test_bracket_numbered_format(self, parser, bracket_numbered_claims):
        """
        Level 2 (Structure): Parse claims with bracket numbering (1), [1].
        """
        claims = parser.parse_claims_text(bracket_numbered_claims)
    
>       assert len(claims) >= 2, (
            f"Expected at least 2 claims from bracket format, got {len(claims)}"
        )
E       AssertionError: Expected at least 2 claims from bracket format, got 1
E       assert 1 >= 2
E        +  where 1 = len([ParsedClaim(claim_number=1, claim_text=', wherein the parsing uses NLP techniques. [3] A computer-readable medium storing instructions for claim', claim_type='independent', parent_claim=None, rag_components=[], char_count=104, word_count=15)])

tests\test_parser.py:208: AssertionError
_______ TestClaimParserLevel4Minimal.test_multiple_paragraphs_fallback ________

self = <test_parser.TestClaimParserLevel4Minimal object at 0x000001B3EC6856D0>
parser = <preprocessor.ClaimParser object at 0x000001B38F746A50>

        def test_multiple_paragraphs_fallback(self, parser):
            """
            Level 4: Multiple paragraphs treated as separate claims.
            """
            multi_para = """
    First paragraph describing the first aspect of the invention. This includes several technical details.
    
    Second paragraph describing another aspect. It references different technologies.
    
    Third paragraph with more details about implementation.
    """
            claims = parser.parse_claims_text(multi_para)
    
>           assert len(claims) >= 2, (
                f"Multiple paragraphs should produce multiple claims, got {len(claims)}"
            )
E           AssertionError: Multiple paragraphs should produce multiple claims, got 1
E           assert 1 >= 2
E            +  where 1 = len([ParsedClaim(claim_number=1, claim_text='First paragraph describing the first aspect of the invention. This includes several technical details. Second paragraph describing another aspect. It references different technologies. Third paragraph with more details about implementation.', claim_type='independent', parent_claim=None, rag_components=[], char_count=240, word_count=30)])

tests\test_parser.py:366: AssertionError
=========================== short test summary info ===========================
FAILED tests/test_hybrid_search.py::TestHybridSearchRRF::test_cross_rank_verification_top_tier
FAILED tests/test_hybrid_search.py::TestHybridSearchRRF::test_asymmetric_weighting_dense_heavy
FAILED tests/test_parser.py::TestClaimParserLevel1Regex::test_rag_component_detection
FAILED tests/test_parser.py::TestClaimParserLevel2Structure::test_bracket_numbered_format
FAILED tests/test_parser.py::TestClaimParserLevel4Minimal::test_multiple_paragraphs_fallback
======================== 5 failed, 22 passed in 2.83s =========================
